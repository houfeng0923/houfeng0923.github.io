## 几个 概念

协程相关  fiber


https://www.cnblogs.com/xybaby/p/6406191.html  同步与异步，回调与协程



———

https://brooch.me/2016/12/30/process-thread-and-coroutine-in-javascript/


相对线程和协程，进程更独立，有自己的内存空间，所以进程间通信比较困难。线程比进程轻量级，属于同一进程的多个线程间可以共享全部资源。协程与线程类似，不同点在于，线程由系统控制切换，协程是由用户控制切换。



———
https://www.zhihu.com/question/32218874  为什么觉得协程是趋势？



———
https://www.zhihu.com/question/20511233

线程确实比协程性能更好。

说协程性能好的，其实真正的原因是因为瓶颈在 IO 上面，而这个时候真正发挥不了线程的作用。

协程的确可以减少 callback 的使用但是不能完全替换 callback。

协程的开销必然比 callback 的开销大。



协程 都没参与 多核 CPU 并行处理，协程 是 不并行 的，而 线程 在多核处理器上是并行在单核处理器是受操作系统调度


协程 的发明主要是为了解决 Concurrency（并发） 问题，而 线程 的发明主要解决的 Parallelism（并行） 问题。



对于 web 类后台开发,比如 restful，协程相比异步回调的优势是极大的简化了业务开发，相比多线程的优势是可以支撑极高的并发量，可以说在 web 后台开发方面，协程是趋势。
但是，web 后台对网络数据的时序要求并不高，在对时序要求严格的领域，并且要满足多人协作的下的实时交互，协程完全没有简化任何东西，数据该同步还是要同步，该加锁还是要加锁，并且还要仔细考虑协程被不可预知的调度可能造成的乱序(调度器带来的问题)，


——
https://lequ7.com/2019/04/26/richang/shen-ru-li-jie-Flutter-duo-xian-cheng/

任务调度
在弄懂协程之前，首先要明白并发和并行的概念，并发指的是由系统来管理多个 IO 的切换，并交由 CPU 去处理。并行指的是多核 CPU 在同一时间里执行多个任务。


并发的实现由非阻塞操作+事件通知来完成，
事件通知也叫做“中断”。

操作过程分为两种，一种是 CPU 对 IO 进行操作，在操作完成后发起中断告诉 IO 操作完成。另一种是 IO 发起中断，告诉 CPU 可以进行操作。

线程本质上也是依赖于中断来进行调度的，线程还有一种叫做“阻塞式中断”，就是在执行 IO 操作时将线程阻塞，等待执行完成后再继续执行。但线程的消耗是很大的，并不适合大量并发操作的处理，而通过单线程并发可以进行大量并发操作。当多核 CPU 出现后，单个线程就无法很好的利用多核 CPU 的优势了，所以又引入了线程池的概念，通过线程池来管理大量线程。

协程

在程序执行过程中，离开当前的调用位置有两种方式，继续调用其他函数和 return 返回离开当前函数。但是执行 return 时，当前函数在调用栈中的局部变量、形参等状态则会被销毁。

协程分为无线协程和有线协程，无线协程在离开当前调用位置时，会将当前变量放在堆区，当再次回到当前位置时，还会继续从堆区中获取到变量。所以，一般在执行当前函数时就会将变量直接分配到堆区，而 async、await 就属于无线协程的一种。有线协程则会将变量继续保存在栈区，在回到指针指向的离开位置时，会继续从栈中取出调用。


async、await 原理
以 async、await 为例，协程在执行时，执行到 async 则表示进入一个协程，会同步执行 async 的代码块。async 的代码块本质上也相当于一个函数，并且有自己的上下文环境。当执行到 await 时，则表示有任务需要等待，CPU 则去调度执行其他 IO，也就是后面的代码或其他协程代码。过一段时间 CPU 就会轮训一次，看某个协程是否任务已经处理完成，有返回结果可以被继续执行，如果可以被继续执行的话，则会沿着上次离开时指针指向的位置继续执行，也就是 await 标志的位置。
由于并没有开启新的线程，只是进行 IO 中断改变 CPU 调度，所以网络请求这样的异步操作可以使用 async、await，但如果是执行大量耗时同步操作的话，应该使用 isolate 开辟新的线程去执行。
